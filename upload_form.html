<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance Report Generator</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }

      input[type="file"],
      input[type="date"],
      input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
      }

      input[type="file"]:focus,
      input[type="date"]:focus,
      input[type="text"]:focus {
        border-color: #4caf50;
        outline: none;
      }

      .button {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .button:hover {
        background: linear-gradient(135deg, #45a049, #3d8b40);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .button:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .download-button {
        background: linear-gradient(135deg, #2196f3, #1976d2);
      }

      .download-button:hover {
        background: linear-gradient(135deg, #1976d2, #1565c0);
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background-color: #f0f0f0;
        border-radius: 3px;
        margin: 20px 0;
        overflow: hidden;
        display: none;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #45a049);
        width: 0%;
        transition: width 0.3s ease;
      }

      .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        display: none;
      }

      .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .help-text {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
      }

      .form-row {
        display: flex;
        gap: 15px;
      }

      .form-row .form-group {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ“Š Attendance Report Generator</h1>

      <form id="attendanceForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="db_file">Database File (ZK.db):</label>
          <input
            type="file"
            id="db_file"
            name="db_file"
            accept=".db"
            required
          />
          <div class="help-text">Upload your ZK.db SQLite database file</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="start_date">Start Date:</label>
            <input type="date" id="start_date" name="start_date" required />
          </div>

          <div class="form-group">
            <label for="end_date">End Date (Optional):</label>
            <input type="date" id="end_date" name="end_date" />
            <div class="help-text">Leave blank to use start date</div>
          </div>
        </div>

        <div class="form-group">
          <label for="public_holidays">Public Holidays (Optional):</label>
          <input
            type="text"
            id="public_holidays"
            name="public_holidays"
            placeholder="2025-06-01,2025-06-15"
          />
          <div class="help-text">
            Enter dates in YYYY-MM-DD format, separated by commas
          </div>
        </div>

        <div class="form-group">
          <button type="submit" class="button" id="generateBtn">
            ðŸš€ Generate Report
          </button>
        </div>

        <div class="progress-bar" id="progressBar">
          <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="status-message" id="statusMessage"></div>
      </form>
    </div>

    <script>
      document
        .getElementById("attendanceForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData();
          const fileInput = document.getElementById("db_file");
          const startDate = document.getElementById("start_date").value;
          const endDate = document.getElementById("end_date").value;
          const publicHolidays =
            document.getElementById("public_holidays").value;

          // Validate inputs
          if (!fileInput.files[0]) {
            showStatus("Please select a database file", "error");
            return;
          }

          if (!startDate) {
            showStatus("Please select a start date", "error");
            return;
          }

          // Add form data
          formData.append("db_file", fileInput.files[0]);
          formData.append("start_date", startDate);
          if (endDate) {
            formData.append("end_date", endDate);
          }
          if (publicHolidays) {
            formData.append("public_holidays", publicHolidays);
          }

          // Show progress
          showProgress(true);
          setProgress(10);
          showStatus("Uploading file and processing...", "info");
          document.getElementById("generateBtn").disabled = true;

          try {
            // Simulate progress updates
            setProgress(30);

            const response = await fetch("/generate-attendance-report", {
              method: "POST",
              body: formData,
            });

            setProgress(70);

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.detail || "Failed to generate report");
            }

            setProgress(90);

            // Get the filename from response headers or create one
            const contentDisposition = response.headers.get(
              "content-disposition"
            );
            let filename = "attendance_report.xlsx";
            if (contentDisposition) {
              const filenameMatch = contentDisposition.match(/filename="(.+)"/);
              if (filenameMatch) {
                filename = filenameMatch[1];
              }
            }

            // Create download link
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);

            setProgress(100);

            // Create download button instead of automatic download
            createDownloadButton(url, filename);
            showStatus(
              "Report generated successfully! Click the download button below.",
              "success"
            );
          } catch (error) {
            console.error("Error:", error);
            showStatus(`Error: ${error.message}`, "error");
          } finally {
            document.getElementById("generateBtn").disabled = false;
            setTimeout(() => {
              showProgress(false);
              setProgress(0);
            }, 2000);
          }
        });

      function createDownloadButton(url, filename) {
        // Remove any existing download button
        const existingButton = document.getElementById("downloadButton");
        if (existingButton) {
          existingButton.remove();
        }

        // Create new download button
        const downloadButton = document.createElement("a");
        downloadButton.href = url;
        downloadButton.download = filename;
        downloadButton.className = "button download-button";
        downloadButton.id = "downloadButton";
        downloadButton.style.marginTop = "15px";
        downloadButton.innerHTML = "ðŸ“¥ Download Report";

        // Add click handler to cleanup URL after download
        downloadButton.addEventListener("click", function () {
          setTimeout(() => {
            window.URL.revokeObjectURL(url);
          }, 1000);
        });

        // Insert button after the form
        document.querySelector(".container").appendChild(downloadButton);
      }

      function showProgress(show) {
        const progressBar = document.getElementById("progressBar");
        progressBar.style.display = show ? "block" : "none";
      }

      function setProgress(percent) {
        const progressFill = document.getElementById("progressFill");
        progressFill.style.width = percent + "%";
      }

      function showStatus(message, type) {
        const statusElement = document.getElementById("statusMessage");
        statusElement.textContent = message;
        statusElement.className = "status-message";
        if (type === "error") {
          statusElement.classList.add("status-error");
        } else if (type === "success") {
          statusElement.classList.add("status-success");
        }
        statusElement.style.display = "block";

        // Auto-hide info messages after 5 seconds
        if (type === "info") {
          setTimeout(() => {
            statusElement.style.display = "none";
          }, 5000);
        }
      }

      // Set today's date as default
      document.getElementById("start_date").valueAsDate = new Date();
    </script>
  </body>
</html>
